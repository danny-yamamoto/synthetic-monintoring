---
title: "KAIZEN Reliability with Synthetic MonitoringğŸª†"
emoji: "ğŸª†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---
[CCoEã‚¯ãƒªã‚¹ãƒã‚¹ï¼ã‚¯ãƒ©ã‚¦ãƒ‰æŠ€è¡“ã‚’æ´»ç”¨ã—ã¦çµ„ç¹”ã‚’ã‚«ã‚¤ã‚¼ãƒ³ã—ãŸäº‹ä¾‹ã‚’æŠ•ç¨¿ã—ã‚ˆã†ï¼ by KINTOãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º Advent Calendar 2023](https://qiita.com/advent-calendar/2023/kinto-technlogies) ã®è¨˜äº‹ã§ã™ã€‚

Qiita é‹å–¶ã®æ–¹ã‹ã‚‰ãŠèª˜ã„ã„ãŸã ãå‚åŠ ã—ã¾ã—ãŸã€‚

è‡ªå·±ç´¹ä»‹ã§ã™ã€‚ç¾è·ã¯ã€å°å£²ã®è²·ã„ç‰©ä½“é¨“å‘ä¸Šã«å–ã‚Šçµ„ã‚€ Software Engineer ã§ã™ã€‚

ä»Šå›ã®é¡Œæã¯ã€ã€ŒSynthetic monitoring ã‚’ä½¿ç”¨ã—ãŸä¿¡é ¼æ€§ã® KAIZENã€ã§ã™ã€‚

CCoE ã®å½¹å‰²ã® 1 ã¤ã§ã‚ã‚‹ã€ŒæŠ€è¡“ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¨é€²ã€ã®ä¸€ç’°ã¨ã—ã¦ã€Synthetic monitoring ã‚’ç”¨ã„ãŸä¿¡é ¼æ€§ã®å‘ä¸Šã¨ã‚µãƒ¼ãƒ“ã‚¹ã® KAIZEN ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

ã•ã‚‰ã«è©³ã—ãè¦‹ãŸã„æ–¹ã¯èª­ã¿ç¶šã‘ã¦ãã ã•ã„ã€‚

## ãƒãƒˆãƒªãƒ§ãƒ¼ã‚·ã‚«çš„ãªä»•äº‹ğŸª†

ã¿ãªã•ã‚“ã®çµ„ç¹”ã§ã¯ã€UI ã®ç¶™ç¶šçš„ãªãƒ†ã‚¹ãƒˆã¯ã€ã©ã®ã‚ˆã†ã«é‹ç”¨ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ

ä¾‹ãˆã°ã€Puppeteer[^5] ã¨ GitHub Actions[^6] ã§è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’æ§‹æˆã—ã¦ã„ãŸã¨ã—ã¾ã™ã€‚

Puppeteer ãŒç¶™ç¶šçš„ã«å‹•ã„ã¦ã„ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯ã—ãªã„ã¨ã„ã‘ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã†ã€‚

```mermaid
flowchart LR
    monitoring1
    monitoring2
    monitoring3[...]
    subgraph runner1 [GitHub Actions]
        tool1[Puppeteer]
    end
    monitoring1 --> runner1
    monitoring2 --> monitoring1
    monitoring3 --> monitoring2
```

ã“ã†ã—ã¦ã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ãŸã‚ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€ã€ã€ã¨ã„ã†ã‚ˆã†ã«ãƒãƒˆãƒªãƒ§ãƒ¼ã‚·ã‚«çš„ã«ãªã‚ŠãŒã¡ã§ã™ã€‚
å†—é•·åŒ–ã«å†—é•·åŒ–ã‚’é‡ã­ã‚‹ã€‚ï¼ˆãƒãƒˆãƒªãƒ§ãƒ¼ã‚·ã‚«ï¼‰

## ãƒãƒˆãƒªãƒ§ãƒ¼ã‚·ã‚«ã‹ã‚‰ã®è§£æ”¾

ã“ã“ã§ Managed Service ã®å‡ºç•ªã§ã™ã€‚

Managed Service ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«ã‚’ç¢ºç´„ã—ã¦ãã‚Œã‚‹é ¼ã‚‚ã—ã„å­˜åœ¨ã§ã™ã€‚

ã§ãã‚Œã°ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–ã‚‚ Managed Service ã§å®Œçµã•ã›ãŸã„ã€‚

ãã“ã§ã€Synthetic monitoring[^2] ã®å‡ºç•ªã§ã™ã€‚

## Synthetic monitoring
ã”å­˜çŸ¥ã®é€šã‚Šã€Synthetic monitoring ã¯ã€2023å¹´11æœˆ03æ—¥ã« GA[^1] ã«ãªã£ãŸ Google Cloud ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

> **Cloud Monitoring**
Synthetic monitors are now GA. You can create synthetic monitors by using Terraform, the Cloud console, and the Monitoring API. You can configure your synthetic monitors to collect log data and trace data. When you use the Cloud console, the generic and Mocha templates are available:

Synthetic monitoring ã¯ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨ä¸€é€£ã®ãƒ†ã‚¹ãƒˆã‚’å®šç¾©ã§ãã¾ã™ã€‚Node.js ã§ã€‚
ä¾‹ãˆã°ã€Login ã‹ã‚‰é·ç§»å…ˆã®ç”»é¢ã®ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šå›ã€CCoE ã¨ã—ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ã®ä¿¡é ¼æ€§ãƒã‚§ãƒƒã‚¯ã‚’è‡ªå‹•åŒ–ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã€è€ƒå¯Ÿã—ã¾ã™ã€‚

## Let's get started.
ä»Šå›ã€ãƒ†ã‚¹ãƒˆã« Puppeteer[^7] ã‚’ä½¿ã„ã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆã®å†…å®¹ã¯ã€ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ ãƒ†ã‚¹ãƒˆã§ã™ã€‚ãƒšãƒ¼ã‚¸ã®ãƒ­ãƒ¼ãƒ‰æ™‚é–“ã‚’æ¸¬å®šã—ã¾ã™ã€‚

å…¬å¼ã® Docs[^8]

```mermaid
flowchart LR
    sm[Synthetic monitor]
    fn[Cloud Functions]
    chrome[Chrome]
    pup[Puppeteer]
    subgraph fn [Cloud Functions]
    end
    subgraph cr [Cloud Run]
        pup -- Performance Tests --> chrome
    end
    fn --> cr
    sm -- Execution --> fn
```

æ¤œè¨¼ç”¨ã®åˆæˆãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

### Create a Function
- Ensure that more memory is available.ã€€`--memory`
- Set a longer timeout. `--timeout`
```bash
sudo gcloud functions deploy $FUNC_NAME \
  --gen2 --region=$REGION --source="." \
  --entry-point=CustomPuppeteerSynthetic --trigger-http --runtime=nodejs18 --project=$PROJECT_ID --memory=2G --timeout=60
```

### Create a synthetic monitor
```bash
sudo curl https://monitoring.googleapis.com/v3/projects/${PROJECT_ID}/uptimeCheckConfigs \
 -H "Authorization: Bearer ${ACCESS_TOKEN}" \
 -H "Content-Type: application/json" --request POST \
 --data '{ "displayName": "'"${DISPLAY_NAME}"'", "synthetic_monitor": {"cloud_function_v2": {"name": "'"${FUNCTION_NAME}"'"} },}'
```

### This is the synthetic monitor.
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/569971/90773703-6564-24f6-9c18-cd225d76a6a0.png)
![image-1.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/569971/e3a74b02-ea25-5bc2-d9b0-2474479c7a84.png)
![image-2.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/569971/45c70e66-0ee8-96ad-ae79-b1c07c5b868a.png)

ã“ã®é€šã‚Šã€ãƒ†ã‚¹ãƒˆãŒå®šæœŸå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ãƒšãƒ¼ã‚¸ã® SLO ãŒæ±ºã¾ã£ã¦ã„ã¦ã€ãã‚Œã‚’å³åº§ã«ç›£è¦–ã—ãŸã„å ´åˆã¯ã€Log Based Alerts[^9] ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ã“ã‚“ãªæ„Ÿã˜ã§ã€‚
ã‚ã¨ã¯ã€Slack ã‚„ SMS ãªã©ã«ç•°å¸¸ã‚’é€šçŸ¥ã•ã›ã‚‹ã€‚
```sql
textPayload:"milliseconds"
```

æœ€å¾Œã«ã€ä»Šå›ã®è¨˜äº‹ã§ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã§ã™ã€‚

https://github.com/danny-yamamoto/synthetic-monintoring

KAIZEN æ´»å‹•ã®å ±å‘Šã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ä½•ã‹å¾—ã‚‰ã‚ŒãŸæ–¹ã¯ã€ã„ã„ã­ â¤ï¸ ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯ã€æ¬¡å›ã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚ğŸ‘‹

## BTW

ã¡ãªã¿ã«ã€Google Cloud ã® Monitoring ã«ã¯ã€é¡ä¼¼ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚‚ã† 1 ã¤ã‚ã‚Šã¾ã™ã€‚
- Uptime checks[^3]
   - å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ URL ã¾ãŸã¯ Google Cloud ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºè¡Œã—ã€äº‹å‰å®šç¾©ã—ãŸ response code ã«åŸºã¥ã„ãŸãƒã‚§ãƒƒã‚¯ã‚’è¡Œãˆã¾ã™ã€‚ç°¡å˜ã«ã„ã†ã¨ Health Check ã® Managed Service ã§ã™ã€‚

https://cloud.google.com/monitoring/uptime-checks/introduction#about-uptime

ä¾‹ã«æ¼ã‚Œãšã€åƒ•ã¯ã€Uptime checks ã® Heavy User ã§ã™ã€‚

[^1]: ä¸€èˆ¬å…¬é–‹
[^2]: https://cloud.google.com/monitoring/uptime-checks/introduction
[^3]: https://cloud.google.com/monitoring/uptime-checks/introduction#about-uptime
[^4]: https://cloud.google.com/monitoring/uptime-checks/introduction#about-sm
[^5]: Node.jsç’°å¢ƒã§å‹•ä½œã—ã€JavaScriptã‚„TypeScriptã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¦ã‚§ãƒ–é–‹ç™ºè€…ã‚„ãƒ†ã‚¹ã‚¿ãƒ¼ã«ã¨ã£ã¦éå¸¸ã«ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
[^6]: ã‚ã‚‰ã‹ã˜ã‚å®šç¾©ã—ãŸå‡¦ç†ã¨æ¡ä»¶ã®çµ„åˆã›ï¼ˆï¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼/Workflowï¼‰ã‚’è‡ªå‹•åŒ–ã™ã‚‹GitHubå…¬å¼ã®æ©Ÿèƒ½ã§ã™ã€‚GitHub Actionsã§ã¯ãƒªãƒã‚¸ãƒˆãƒªã«å¯¾ã™ã‚‹ãƒ—ãƒƒã‚·ãƒ¥ãªã©ã®å‡¦ç†ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ã€å°‚ç”¨ã®Workflowã«å®šç¾©ã—ã¦ãŠã„ãŸå‡¦ç†ã‚’è‡ªå‹•ã§å®Ÿè¡Œã—ã¾ã™ã€‚
[^7]: ä¸»ã«ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•åŒ–ã¨ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆã®ãŸã‚ã® Node ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
[^8]: https://github.com/GoogleCloudPlatform/synthetics-sdk-nodejs/blob/b150be2a7f25face543832b1721c77eb680a5c71/samples/generic-puppeteer-nodejs/README.md
[^9]: https://cloud.google.com/logging/docs/alerting/log-based-alerts?hl=ja
